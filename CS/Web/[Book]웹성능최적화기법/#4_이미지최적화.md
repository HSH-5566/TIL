# 이미지 최적화

## 1. 이미지의 중요성

- 현재 웹 페이지에 사용되는 이미지의 크기/수 증가 추세
- 화소 밀도: 물리 스크린안에 얼마나 많은 수의 픽셀 압축되어 있는가
  - 픽셀 수 많을수록 화소밀도 높고 화면 선명
  - 기기 픽셀 비율(1x, 2x,,,)로 표현: 단위 길이 안의 픽셀 수 상대적으로 나타내는 단위
  - PPI: 인치당 픽셀 개수
- 포인트: 웹 이미지 크기 표현하는 용어 중 하나
  - 40 픽셀 이미지 = 40픽셀 너비의 이미지 하나
  - 40 포인트 이미지 = 1x에선 40픽셀, 2x 80픽셀,,,너비의 이미지
- Hero 이미지(대문 이미지)
  - 늦게 로딩시 사용자의 불편
- 이미지는 웹 사이트의 기능, 성능 면에서 중요

## 2. 디지털 이미지의 종류와 특성

- 데스크톱 이미지 vs 모바일 이미지
  - PNG: 사용시 무게가 더 무거움, 알파채널 이미지 변환기법
    - !알파채널: 핵심 이미지 레이어 제외한 배경 이미지 레이어 제거해 전체 이미지 투명화 가능
    - 같은 품질의 JPEG보다 무거움
      > 투명 기능 불필요시 JPEG으로 변환
  - 사용목적, 기기에 맞는 이미지 선택 필요
- 레스터 이미지 vs 벡터 이미지
  - 래스터 이미지: 픽셀에 색상정보 입력해 컴퓨터로 표현
    - 확장성 부족: 사이즈 키우기위해 픽셀 추가 필요
  - 벡터 이미지: 대상의 수학적정보 제공 - 화면 크기에 상관없이 선명한 이미지 - 그림 복잡 시 수학적정보로 표현할 때 제약 - SVG파일: 텍스트 기반 콘텐츠
    > 래스터 이미지는 꾸준히 네트워크 전송용 이미지로 사용된 형식존재
- 무손실 이미지 형식 vs 손실 이미지 형식
  - 무손실 이미지
    - GIF: 색상 제한
    - PNG: 알파채널(투명기능)
  - 손실 이미지: JPEG & 브라우저 특화 이미지 유형
    - JPEG: 사진 저장 표준형식, 인식가능 외 색상제거
    - WebP: 점진적 전송 미지원
    - JPEG XR: 더많은 색상지원
    - JPEG 2000: 대부분의 브라우저에서 미지원

## 3. 이미지 변환 기법

- 무손실 압축
  - 스크립트 통해 압축 자동화가능
  - 라이브러리 통해 자동화
    - GIF
      - ImageMagicK
      - Giflossy
      - Gifsicle
      - git2webp converter: gif -> webp
    - PNG: 핵심청크외 사용자정의청크 삭제통한 이미지크기감소가능
      - Pngcrush
      - Pngquant
    - JPEG: 메타데이터(주석,,) 삭제통한 이미지크기감소가능
      - MozJPEG
      - libJpeg
      - Guetzli
- 손실 압축
  - 특정 이미지정보 누락, 손실시켜 파일크기 감소
  - JPEG품질: 100~75%\_ 품질저하 알기어렵&파일크기 효과적감소
  - 기존 이미지 디코딩 후 화질저하시켜 원래 이미지로 인코딩
    - ImageMagicK이 지원
      - `convert input.jpg -quality 80 output.jpg`
  - 적절한 손실 압축 품질 지수
    - UX저하 않고 이미지크기 감소
    - 최적 품질지수 찾기위해 수치화하는 알고리즘
      1. 평균제곱오차(MSE): 작을수록 유사
      2. 최대신호 대 잡음 비(PSNR): 클수록 유사
      3. 구조적유사도(SSIM): 1에 가까울수록 유사
      - 역구조적 유사도(DSSIM): 0에 가까울수록 유사
    - 화질같은 이미지여도 손실압축 라이브러리, 이미지형식따라 SSIM다름
  - 시각적 인지 능력을 고려한 자동 최적화 도구
    - 이미지화질\_ 원본이미지정보&사용자웹환경 고려필요(브라우저, 화면해상도,,,)
      - 클라이언트정보획득 -> SSIM결정 -> 화질수준계산 -> 변환
    - 자동최적화 기능 도구
      - CDN서비스 제공업체(Akamai...): 이미지 트래픽관련 자동최적화 기능
      - Cloudinary: 클라우드 상 이미지, 비디오 관리 솔루션
      - JPEGmini: 오프라인 최적화 도구(사용자환경고려 불가)
  - 브라우저 특화 이미지로 변환
    - 형태별 이미지 변환도구
      - WebP
        - `cwebp -q 80 image.png -o image.webp`
        - `webp image.webp -o image.png`
        - ImageMagicK
      - JPEG 2000
        - OpenJPEG
      - JPEG XR
        - jxrlib

## 4. 반응형 웹에서의 이미지 배치 전략

- 엠닷사이트(m.): 모바일 사용자의 웹사이트 접속 증가로 모바일 전용 사이트 별도 구축
  - 기기 다양화 문제\_ 엠닷 사이트 하나로 모든기기 환경 구축 불가
  - 유지보수 문제
  - 모바일 사용자의 사용성 문제\_ 데스크탑과 동일한 사용성 요구
    > 반응형 웹: 각종 기기의 화면 크기에 맞춘 최적화된 웹 페이지 제공
  - 미디어 쿼리, 가변 그리드, 유동형 이미지,,, 기술 적용
  - 유지보수 필요성 감소
  - 모바일 사용자의 사용성 개선
  - SEO측면 이점\_ 구글: 반응형 웹 사용한 웹 사이트에 Mobile-Friendly 타이틀과 함께 검색 우선순위 높이기로 공언
- 반응형 웹의 문제점
  - 성능 측면 효과적이지 못함: 웹 페이지의 무게 반응적이지 않음
    - 모바일 환경의 경우 데스크톱보다 환경 열악: 성능저하
  - 원인은 이미지의 크기: 사용자의 웹 환경따라 변하지 않음
    - 웹 리소스를 필요이상으로 과하게 내려받는 현상 1. 내려받아 줄이기 - 화면의 크기 변해도 실제 이미지 크기변화 없음 2. 내려받아 숨기기 - 불필요한 리소스 다운 후 숨기기(display: none) 3. 화면 바깥 부분 - 화면 바깥 부분 모두 다운시 화면안쪽부분 로딩시간 증가
      > 모바일 환경에서 필요치 않은 리소스를 과도하게 다운
- 반응형 이미지

  - 사용자 환경따라 환경에 적합한 이미지 전송
  - 특정 이미지 요청시 환경에 맞도록 변경된 이미지 전송<->유동형 이미지(브라우저에서 이미지 다운 후 처리)
  - ex) CDN업체에서 사용자화면 고려한 여러 이미지 준비
  - 반응형 이미지 구현 방법

    - 프런트엔드 측면
      - 미디어 쿼리 이용해 클라이언트 환경 파악 후 맞는 이미지파일 호출, 과도 사용시 프런트 코드 무거워져 성능에 영향 가능
      - `<img>`의 srcset, size속성
        - srcset: 사용자 환경따라 다른 이미지 URL, 화소밀도정보 이용
        - size: 브레이크 포인트 따른 이미지 크기 지정, width 정보 이용
          <pre>
          <code>
          //200w, 400w 이미지의 width
          //size 이미지가 화면에 표현될 크기
          //srcset 브라우저에 적절한 이미지 선택 힌트
          // 화면크기가 0~400 픽셀일때 이미지 사이즈를 전체 뷰포트의 100%
            <`img src="small.jpg" alt="rwd"
              srcset="pic-200.jpg 200w, pic-400.jpg 400w"
              size="(max-width: 400px) 100vw, (max-width: 800px) 30vw, 300px">
          </code>
          </pre>
          > 동일 이미지를 크기만 다르게 할 때 이용
      - `<picture>`
        - `<source>`이용해 다양한 이미지 URL 설정 가능, 미디어 쿼리로 각 URL 로딩조건 구체적 정의
        - 내려받아 숨기기&내려받아 줄이기 해결: 조건에 맞지않는 이미지 다운안함
        - 모든 브라우저가 지원하지 않음&HTML소스 길어짐
          - polyfill(코드조각, 플러그인)이용해 지원안해도 이용가능 ex) Picturefill
    - 백엔드 측면
      - 서버에서 클라환경에 맞는 이미지 선택해 전송, 프런트 코드 추가없어 성능 향상 가능, 클라환경 정확히 판단&서버 프로그램 추가필요
      - Client Hints
        - 브라우저에서 최초서버로 HTTP요청
        - 서버가 응답헤더에 Accept-CH추가해 Client-Hints 지원함 브라우저에 알림&필요 정보요청
          - ex) `Accept-CH: DPR, Width, Viewport-Width`
        - 브라우저가 요청된 정보 헤더에 추가해 전송
        - 서버가 최적화된 이미지 전송 후 사용한 DPR정보 마지막응답 메세지로 전송
          - DPR: 브라우저가 서버에서 받은 이미지 처리시 사용
      - 이미지 지연 로딩
        - js를 사용한 지연로딩방법
          <pre>
          <code>
          //img태그의 src에 가짜 이미지 링크, 실제 이미지는 data-src에 정의
          // onload이벤트 발생시 loadReal홏ㄹ
            function loadReal(img){
              if(img.display!= "none"){
                img.onload = null;
                img.src = img.getAttribute("data-src");
              }
            }
            <`img src="1px.gif" data-src="book.jpg" alt="A Book" onload="loadReal(this)">
          </code>
          </pre>
        - ex) lazyload: 지연로딩 지원하는 라이브러리
      - 모바일 우선 접근
        - 모바일 기기에 적합한 페이지부터 개발하는 방법
    - Art direction: 이미지의 특징, 가치가 기기따라 표현되도록 crop
